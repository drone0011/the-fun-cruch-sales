<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Fun Crunch Sales Tracker 2.0</title>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <link
    href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
    rel="stylesheet"
  />
</head>

<body class="bg-gray-50 p-6">
  <div id="root"></div>

  <script type="text/babel">
    /* -------------------------------------------------------
       PRODUCT LIST (CLEANED ‚Äî NO CARDS SOLD)
    --------------------------------------------------------*/
    const PRODUCTS = [
      { key: "chips", label: "üçü Chips" },
      { key: "drinkcan", label: "ü•§ Drink (Can)" },
      { key: "drinkcup", label: "ü•§ Drink (Cup)" },
      { key: "sweets", label: "üç¨ Sweets" },
      { key: "combo", label: "üßÉ Combo (1 Chip + 1 Drink)" },
      { key: "mysterybag", label: "üéÅ Mystery Bag" },
      { key: "spin", label: "üé° Spin Item" },
    ];

    const LOCAL_KEY = "funcrunch_sales_v4";

    function formatAED(n) {
      return "AED " + Number(n).toFixed(2);
    }

    function nowTimestamp() {
      const d = new Date();
      return (
        d.toLocaleDateString() + " ‚Ä¢ " +
        d.toLocaleTimeString()
      );
    }

    function App() {
      const [sales, setSales] = React.useState([]);
      const [product, setProduct] = React.useState(PRODUCTS[0].key);
      const [unitPrice, setUnitPrice] = React.useState(5);
      const [qty, setQty] = React.useState(1);
      const [paymentType, setPaymentType] = React.useState("card");
      
      const [cart, setCart] = React.useState([]);
      const [campaignName, setCampaignName] = React.useState("");
      const [campaignActive, setCampaignActive] = React.useState(false);
      const [luckyDrawEntries, setLuckyDrawEntries] = React.useState([]);

      const [lastSaved, setLastSaved] = React.useState(null);

      /* ---------------- Load saved data ---------------- */
      React.useEffect(() => {
        try {
          const raw = localStorage.getItem(LOCAL_KEY);
          if (!raw) return;
          const data = JSON.parse(raw);
          setSales(data.sales || []);
          setLuckyDrawEntries(data.luckyDrawEntries || []);
        } catch (err) {
          console.error(err);
        }
      }, []);

      /* ---------------- Save to storage ---------------- */
      React.useEffect(() => {
        localStorage.setItem(
          LOCAL_KEY,
          JSON.stringify({ sales, luckyDrawEntries })
        );
        setLastSaved(nowTimestamp());
      }, [sales, luckyDrawEntries]);

      /* ---------------- CART ACTIONS ---------------- */
      function addItemToCart() {
        setCart(prev => [...prev, {
          product,
          qty: Number(qty),
          unitPrice: Number(unitPrice)
        }]);
        setQty(1);
      }

      function removeItem(i) {
        setCart(cart.filter((_, idx) => idx !== i));
      }

      /* ---------------- PROCESS SALE ---------------- */
      function confirmSale() {
        if (cart.length === 0) {
          alert("Your cart is empty!");
          return;
        }

        const totalAED = cart.reduce(
          (sum, i) => sum + i.unitPrice * i.qty, 0
        );

        const receiptId = "FC-" + String(Date.now()).slice(-5);

        const sale = {
          id: receiptId,
          ts: nowTimestamp(),
          cart,
          totalAED: Number(totalAED.toFixed(2)),
          paymentType,
          campaign: campaignActive ? campaignName : null,
        };

        setSales(prev => [sale, ...prev]);

        /* Add Lucky Draw entry */
        setLuckyDrawEntries(prev => [
          ...prev,
          { id: receiptId, ts: sale.ts, amount: totalAED }
        ]);

        setCart([]);
      }

      /* ---------------- RESET DAY ---------------- */
      function resetAll() {
        if (!confirm("Reset all data? Make sure to download CSV first!")) return;

        setSales([]);
        setLuckyDrawEntries([]);
        localStorage.removeItem(LOCAL_KEY);
      }

      /* ---------------- TOTALS ---------------- */
      const totals = sales.reduce((acc, s) => {
        acc.revenue += s.totalAED;
        return acc;
      }, { revenue: 0 });

      /* ---------------- CSV ---------------- */
      function downloadCSV() {
        const rows = sales.map(s => ({
          Receipt: s.id,
          Time: s.ts,
          Payment: s.paymentType,
          Campaign: s.campaign || "",
          Total_AED: s.totalAED
        }));

        if (!rows.length) return alert("Nothing to export");

        const header = Object.keys(rows[0]);
        const csv = [
          header.join(","),
          ...rows.map(r => header.map(h => r[h]).join(","))
        ].join("\n");

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "funcrunch_sales.csv";
        a.click();
        URL.revokeObjectURL(url);
      }

      return (
        <div className="max-w-6xl mx-auto space-y-6">
          <h1 className="text-4xl font-extrabold text-yellow-600 flex items-center gap-3">
            üçü The Fun Crunch Sales Tracker 2.0
          </h1>

          {/* ---------------- LEFT SIDE ---------------- */}
          <div className="grid md:grid-cols-2 gap-6">

            {/* SALES ENTRY */}
            <div className="bg-white p-6 shadow rounded-lg space-y-4">
              <h2 className="font-bold text-lg text-yellow-700">New Sale</h2>

              <div>
                <label className="font-medium text-sm">Product</label>
                <select className="w-full p-2 border rounded"
                  value={product}
                  onChange={(e) => setProduct(e.target.value)}
                >
                  {PRODUCTS.map(p => (
                    <option key={p.key} value={p.key}>
                      {p.label}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="font-medium text-sm">Unit Price (AED)</label>
                <input
                  type="number"
                  value={unitPrice}
                  onChange={(e) => setUnitPrice(e.target.value)}
                  className="w-full p-2 border rounded"
                />
              </div>

              <div>
                <label className="font-medium text-sm">Quantity</label>
                <input
                  type="number"
                  min="1"
                  value={qty}
                  onChange={(e) => setQty(e.target.value)}
                  className="w-full p-2 border rounded"
                />
              </div>

              <button
                onClick={addItemToCart}
                className="bg-yellow-500 hover:bg-yellow-600 text-white w-full p-2 rounded font-medium"
              >
                ‚ûï Add To Cart
              </button>

              {cart.length > 0 && (
                <div className="bg-yellow-50 p-3 rounded border mt-3">
                  <h3 className="font-bold mb-2">Cart</h3>
                  {cart.map((i, idx) => (
                    <div key={idx} className="flex justify-between py-1 text-sm">
                      <span>
                        {PRODUCTS.find(p => p.key === i.product).label} √ó {i.qty}
                      </span>
                      <span>{formatAED(i.unitPrice * i.qty)}</span>
                      <button
                        onClick={() => removeItem(idx)}
                        className="text-red-500 ml-2"
                      >
                        ‚úñ
                      </button>
                    </div>
                  ))}
                </div>
              )}

              <div>
                <label className="font-medium text-sm">Payment Type</label>
                <select
                  className="w-full p-2 border rounded"
                  value={paymentType}
                  onChange={e => setPaymentType(e.target.value)}
                >
                  <option value="card">üí≥ Card</option>
                  <option value="cash">üíµ Cash</option>
                </select>
              </div>

              <div className="mt-4 border-t pt-4">
                <label className="font-medium text-sm">Campaign Mode</label>
                <div className="flex gap-2 mt-1">
                  <input
                    type="checkbox"
                    checked={campaignActive}
                    onChange={(e) => setCampaignActive(e.target.checked)}
                  />
                  <input
                    type="text"
                    placeholder="Campaign name"
                    className="flex-1 p-2 border rounded"
                    disabled={!campaignActive}
                    value={campaignName}
                    onChange={(e) => setCampaignName(e.target.value)}
                  />
                </div>
              </div>

              <button
                onClick={confirmSale}
                className="bg-green-500 hover:bg-green-600 text-white w-full p-3 rounded font-semibold mt-3"
              >
                ‚úÖ Confirm Sale
              </button>
            </div>

            {/* RIGHT SIDE PANELS */}
            <div className="space-y-4">
              <div className="bg-white p-4 shadow rounded">
                <h3 className="font-bold text-lg text-yellow-700">Totals</h3>
                <p className="mt-2 text-xl font-bold">{formatAED(totals.revenue)}</p>
              </div>

              <div className="bg-white p-4 shadow rounded max-h-64 overflow-y-auto">
                <h3 className="font-bold mb-2">Lucky Draw Entries</h3>
                {luckyDrawEntries.slice(-10).map((e, idx) => (
                  <div key={idx} className="border-b py-1 text-sm">
                    {e.id} ‚Ä¢ {formatAED(e.amount)}
                  </div>
                ))}
              </div>

              <div className="flex gap-2">
                <button onClick={downloadCSV}
                  className="flex-1 bg-blue-500 hover:bg-blue-600 text-white p-2 rounded">
                  üì• Export CSV
                </button>

                <button onClick={resetAll}
                  className="flex-1 bg-red-100 hover:bg-red-200 text-red-600 p-2 rounded">
                  Reset
                </button>
              </div>
            </div>
          </div>

          {/* Recent Sales */}
          <div className="bg-white p-4 rounded shadow mt-6">
            <h3 className="font-bold text-lg mb-3">Recent Sales</h3>
            {sales.slice(0, 6).map(s => (
              <div key={s.id} className="border rounded p-3 mb-2 text-sm">
                <div className="font-bold">{s.id}</div>
                <div className="text-gray-600">{s.ts}</div>

                {s.cart.map((i, idx) => (
                  <div key={idx} className="flex justify-between ml-3">
                    <span>{PRODUCTS.find(p => p.key === i.product).label} √ó {i.qty}</span>
                    <span>{formatAED(i.unitPrice * i.qty)}</span>
                  </div>
                ))}

                <div className="text-right font-bold border-t pt-1 mt-2">
                  Total: {formatAED(s.totalAED)} ({s.paymentType})
                </div>

                {s.campaign && (
                  <div className="text-xs text-blue-600 text-right">Campaign: {s.campaign}</div>
                )}
              </div>
            ))}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
