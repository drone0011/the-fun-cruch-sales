<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>The Fun Crunch ‚Äî Sales Tracker</title>

    <!-- Tailwind CDN for styling (playful theme) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM (UMD builds) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX in this single file (development only) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body class="bg-gradient-to-br from-yellow-50 via-white to-blue-50 min-h-screen font-sans">
    <div id="root" class="p-6 max-w-5xl mx-auto"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // Constants
      const PRODUCTS = [
        { key: 'spinchip', label: 'üçü Spin (Chips)' },
        { key: 'spinchip', label: 'üéØ Spin (Drinks)' },
        { key: 'random', label: 'üïµÔ∏è‚Äç‚ôÇÔ∏è Mystery Item (Spin) ' },
        { key: 'random2', label: 'üïµÔ∏è‚Äç‚ôÇÔ∏è Mystery Item (Bag) ' },
        { key: 'mysterychip', label: 'üõçÔ∏è Mystery Bag (Chips)' },
        { key: 'mysterydrink', label: 'ü•§ Mystery Bag (Drinks)' },
        { key: 'chip', label: 'üçü Chips' },
        { key: 'chip', label: 'üßÉ Drink' },
        { key: 'combo', label: 'üßÉ Combo 1 (1 Chip + 1 Drink)'},
        { key: 'combo', label: 'üßÉ Combo 2 (1 Chip/Drink and Card)'},
        { key: 'combo', label: 'üÉè Refer A Friend Card (Free At AED5)'},
        { key: 'combo', label: 'üÉè Lucky Draw Card (Free At AED10)'},
         { key: 'combo', label: 'üÉè Cards'},
        { key: 'packs', label: 'üÉè Packs'},
        
         
        
      ];
      const SB_TO_AED = 5; // 1 Student Buck = AED 5
      const LOCAL_KEY = 'funcrunch_sales_v1';

      function formatAED(n){ return 'AED ' + (Math.round(n*100)/100).toFixed(2); }

      // Helper: download CSV
      function downloadCSV(rows, filename='funcrunch_sales.csv'){
        if(!rows.length) return;
        const header = Object.keys(rows[0]);
        const csv = [
          header.join(','),
          ...rows.map(r => header.map(h => {
            const v = r[h] === null || r[h] === undefined ? '' : String(r[h]).replace(/"/g,'""');
            // Quote fields with comma
            return /,|\n|"/.test(v) ? `"${v}"` : v;
          }).join(','))
        ].join('\n');
        const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      function App(){
        // sales: array of objects { id, ts, product, qty, unitPrice, paymentType, studentBucks, amountAED }
        const [sales, setSales] = useState([]);
        const [product, setProduct] = useState('spin');
        const [unitPrice, setUnitPrice] = useState(5.00); // default unit price (editable)
        const [qty, setQty] = useState(1);
        const [paymentType, setPaymentType] = useState('studentbucks'); // 'studentbucks' or 'aed'
        const [studentBucksReceived, setStudentBucksReceived] = useState('');
        const [lastSaved, setLastSaved] = useState(null);

        // load from localStorage
        useEffect(() => {
          try {
            const raw = localStorage.getItem(LOCAL_KEY);
            if(raw){ const parsed = JSON.parse(raw); setSales(parsed); }
          } catch(e){ console.error(e); }
        }, []);

        // save to localStorage
        useEffect(() => {
          localStorage.setItem(LOCAL_KEY, JSON.stringify(sales));
          setLastSaved(new Date().toLocaleString());
        }, [sales]);

        // Derived stats
        const totals = sales.reduce((acc,s) => {
          acc.totalAED += Number(s.amountAED || 0);
          acc.totalSB += Number(s.studentBucks || 0);
          acc.units[s.product] = (acc.units[s.product] || 0) + Number(s.qty || 0);
          return acc;
        }, { totalAED:0, totalSB:0, units:{} });

        // Add sale handler
        function handleAddSale(){
          const uPrice = Number(unitPrice) || 0;
          const q = Math.max(1, Math.floor(Number(qty) || 0));
          let amountAED = 0;
          let sb = 0;
          if(paymentType === 'studentbucks'){
            if(studentBucksReceived !== ''){
              sb = Number(studentBucksReceived) || 0;
              amountAED = sb * SB_TO_AED;
            } else {
              // auto-calc required student bucks from unitPrice*qty
              const requiredAED = uPrice * q;
              sb = Math.round(requiredAED / SB_TO_AED * 100) / 100; // allow fractional if needed
              amountAED = requiredAED;
            }
          } else {
            // AED payment
            amountAED = uPrice * q;
            sb = 0;
          }

          const newSale = {
            id: 's' + Date.now(),
            ts: new Date().toLocaleString(),
            product,
            qty: q,
            unitPrice: Number(uPrice),
            paymentType,
            studentBucks: Number(sb),
            amountAED: Number(Math.round(amountAED*100)/100)
          };

          setSales(prev => [newSale, ...prev]);
          // reset small fields
          setQty(1);
          setStudentBucksReceived('');
        }

        function handleResetDay(){
          if(!confirm('Reset day? This will archive current data in localStorage but keep a downloadable CSV copy first.')){
            return;
          }
          // download CSV first
          if(sales.length){
            downloadCSV(sales, 'funcrunch_sales_backup_' + new Date().toISOString().slice(0,10) + '.csv');
          }
          setSales([]);
          localStorage.removeItem(LOCAL_KEY);
        }

        return (
          <div className="space-y-6">
            <header className="flex items-center justify-between">
              <div>
                <h1 className="text-3xl font-extrabold text-yellow-600 flex items-center gap-3">
                  <span>üçü</span> <span>The Fun Crunch</span>
                </h1>
                <p className="text-sm text-gray-600">Sales Tracker ‚Äî playful, simple, for Student Bucks & AED</p>
              </div>
              <div className="text-right">
                <div className="text-sm text-gray-700">Last saved:</div>
                <div className="font-medium text-gray-800">{ lastSaved || '‚Äî' }</div>
              </div>
            </header>

            {/* Form */}
            <div className="bg-white shadow rounded-lg p-6 grid md:grid-cols-2 gap-4">
              <div className="space-y-3">
                <label className="block text-sm font-medium text-gray-700">Product</label>
                <select className="w-full rounded-md p-2 border" value={product} onChange={e=>setProduct(e.target.value)}>
                  {PRODUCTS.map(p => <option key={p.key} value={p.key}>{p.label}</option>)}
                </select>

                <div>
                  <label className="block text-sm font-medium text-gray-700">Unit price (AED)</label>
                  <input type="number" step="0.01" className="w-full rounded-md p-2 border" value={unitPrice} onChange={e=>setUnitPrice(e.target.value)} />
                  <div className="text-xs text-gray-500 mt-1">Enter the price in AED for one unit (editable per sale)</div>
                </div>

                <div className="flex gap-3">
                  <div className="flex-1">
                    <label className="block text-sm font-medium text-gray-700">Quantity</label>
                    <input type="number" min="1" className="w-full rounded-md p-2 border" value={qty} onChange={e=>setQty(e.target.value)} />
                  </div>

                  <div className="flex-1">
                    <label className="block text-sm font-medium text-gray-700">Payment Type</label>
                    <select className="w-full rounded-md p-2 border" value={paymentType} onChange={e=>setPaymentType(e.target.value)}>
                      <option value="studentbucks">üéüÔ∏è Student Bucks (1 SB = AED 5)</option>
                      <option value="aed">üíµ AED (Cash)</option>
                    </select>
                  </div>
                </div>

                {paymentType === 'studentbucks' && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700">Student Bucks Received (optional)</label>
                    <input placeholder="Leave blank to auto-calc from AED" type="number" step="0.01" min="0" className="w-full rounded-md p-2 border" value={studentBucksReceived} onChange={e=>setStudentBucksReceived(e.target.value)} />
                    <div className="text-xs text-gray-500 mt-1">If left empty we'll auto-convert AED‚ÜíSB for the quantity you entered.</div>
                  </div>
                )}

                <div className="flex gap-2 mt-3">
                  <button onClick={handleAddSale} className="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md font-semibold">‚ûï Add Sale</button>
                  <button onClick={()=>{ navigator.clipboard && navigator.clipboard.writeText(JSON.stringify(sales.slice(0,10),null,2)); alert('Preview of latest sales copied to clipboard (for quick copy).'); }} className="bg-blue-100 hover:bg-blue-200 text-blue-800 px-4 py-2 rounded-md">Preview JSON</button>
                </div>
              </div>

              {/* Calculations & quick info */}
              <div className="space-y-4">
                <div className="p-4 rounded-lg bg-gradient-to-br from-yellow-100 to-red-50 shadow">
                  <h3 className="font-bold text-lg text-yellow-700">Live Totals</h3>
                  <div className="mt-2 grid grid-cols-2 gap-2">
                    <div className="p-2 bg-white rounded text-center shadow">
                      <div className="text-xs text-gray-500">Total Revenue</div>
                      <div className="font-semibold text-lg">{formatAED(totals.totalAED)}</div>
                    </div>
                    <div className="p-2 bg-white rounded text-center shadow">
                      <div className="text-xs text-gray-500">Total SB Collected</div>
                      <div className="font-semibold text-lg">{totals.totalSB || 0} SB</div>
                      <div className="text-xs text-gray-400">{formatAED(totals.totalSB * SB_TO_AED)}</div>
                    </div>
                    <div className="p-2 bg-white rounded text-center shadow">
                      <div className="text-xs text-gray-500">Total AED (incl SB value)</div>
                      <div className="font-semibold text-lg">{formatAED(totals.totalAED)}</div>
                    </div>
                    <div className="p-2 bg-white rounded text-center shadow">
                      <div className="text-xs text-gray-500">Unique Sales</div>
                      <div className="font-semibold text-lg">{sales.length}</div>
                    </div>
                  </div>
                </div>

                <div className="p-4 rounded-lg bg-white shadow">
                  <h3 className="font-bold">Units Sold</h3>
                  <div className="mt-2 space-y-2">
                    {PRODUCTS.map(p => (
                      <div key={p.key} className="flex justify-between text-sm">
                        <div>{p.label}</div>
                        <div className="font-semibold">{totals.units[p.key] || 0}</div>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="flex gap-2">
                  <button onClick={() => downloadCSV(sales)} className="flex-1 bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-md font-semibold">üì• Download CSV</button>
                  <button onClick={handleResetDay} className="flex-1 bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded-md">Reset Day</button>
                </div>

                <div className="text-xs text-gray-500">Note: Data is stored in your browser's local storage. Use Download CSV to back up or share end-of-day results.</div>
              </div>
            </div>

            {/* Last transactions */}
            <div className="grid md:grid-cols-2 gap-4">
              <div className="bg-white p-4 rounded shadow">
                <h3 className="font-bold">Last 5 Transactions</h3>
                <div className="mt-3 space-y-2">
                  {sales.slice(0,5).map(s => (
                    <div key={s.id} className="flex items-center justify-between border p-2 rounded">
                      <div>
                        <div className="text-sm font-semibold">{PRODUCTS.find(p=>p.key===s.product)?.label || s.product} √ó {s.qty}</div>
                        <div className="text-xs text-gray-500">{s.ts} ‚Ä¢ {s.paymentType === 'studentbucks' ? `${s.studentBucks} SB (${formatAED(s.amountAED)})` : `${formatAED(s.amountAED)} AED`}</div>
                      </div>
                      <div className="font-semibold text-gray-800">{formatAED(s.amountAED)}</div>
                    </div>
                  ))}
                  {!sales.length && <div className="text-sm text-gray-500">No sales yet ‚Äî add one above.</div>}
                </div>
              </div>

              <div className="bg-white p-4 rounded shadow">
                <h3 className="font-bold">Quick Inventory Hint</h3>
                <p className="text-sm text-gray-600">This tracker logs sales but does not auto-reduce inventory yet. For a simple manual inventory estimate, keep a printed shopping checklist and subtract sold units at intervals.</p>
                <div className="mt-3">
                  <button onClick={() => {
                    const totalByProduct = PRODUCTS.map(p => {
                      return {product:p.key, sold: totals.units[p.key] || 0};
                    });
                    alert('Units sold summary:\\n' + totalByProduct.map(r=>`${r.product}: ${r.sold}`).join('\\n'));
                  }} className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-md">Show Units Summary</button>
                </div>
              </div>
            </div>

            <footer className="text-center text-xs text-gray-500 mt-6">
              Built for The Fun Crunch ‚Ä¢ Student Souk ‚Ä¢ Local storage + CSV export
            </footer>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
