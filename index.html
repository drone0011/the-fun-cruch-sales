<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>The Fun Crunch ‚Äî Sales Tracker</title>

    <!-- Tailwind for playful styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React + ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>

  <body class="bg-gradient-to-br from-yellow-50 via-white to-blue-50 min-h-screen font-sans">
    <div id="root" class="p-6 max-w-5xl mx-auto"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      const PRODUCTS = [
        { key: 'spin', label: 'üéØ Spin' },
        { key: 'mystery', label: 'üõçÔ∏è Mystery Bag' },
        { key: 'combo', label: 'üßÉ Combo' },
        { key: 'cards', label: 'üÉè Cards' },
      ];

      const SB_TO_AED = 5;
      const LOCAL_KEY = 'funcrunch_sales_v2';
      const SHEET_URL = "https://script.google.com/macros/s/AKfycbzlUrQ7uWs70i9Gku4jIAiCEHbJeY_AdABNKTzap4_3UVmn53_obx-NJTXZTvyn5RM2/exec";

      function formatAED(n) {
        return 'AED ' + (Math.round(n * 100) / 100).toFixed(2);
      }

      function downloadCSV(rows, filename = 'funcrunch_sales.csv') {
        if (!rows.length) return;
        const header = Object.keys(rows[0]);
        const csv = [
          header.join(','),
          ...rows.map(r =>
            header
              .map(h => {
                const v = r[h] ?? '';
                return /,|\n|"/.test(v)
                  ? `"${String(v).replace(/"/g, '""')}"`
                  : v;
              })
              .join(',')
          ),
        ].join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      function App() {
        const [sales, setSales] = useState([]);
        const [product, setProduct] = useState('spin');
        const [unitPrice, setUnitPrice] = useState(5.0);
        const [qty, setQty] = useState(1);
        const [paymentType, setPaymentType] = useState('studentbucks');
        const [studentBucksReceived, setStudentBucksReceived] = useState('');
        const [message, setMessage] = useState('');

        useEffect(() => {
          const raw = localStorage.getItem(LOCAL_KEY);
          if (raw) setSales(JSON.parse(raw));
        }, []);

        useEffect(() => {
          localStorage.setItem(LOCAL_KEY, JSON.stringify(sales));
        }, [sales]);

        const totals = sales.reduce(
          (acc, s) => {
            acc.totalAED += s.amountAED || 0;
            acc.totalSB += s.studentBucks || 0;
            acc.units[s.product] = (acc.units[s.product] || 0) + s.qty;
            return acc;
          },
          { totalAED: 0, totalSB: 0, units: {} }
        );

        function handleAddSale() {
          const uPrice = Number(unitPrice);
          const q = Math.max(1, Number(qty));
          let sb = 0, amountAED = 0;

          if (paymentType === 'studentbucks') {
            if (studentBucksReceived !== '') {
              sb = Number(studentBucksReceived);
              amountAED = sb * SB_TO_AED;
            } else {
              amountAED = uPrice * q;
              sb = amountAED / SB_TO_AED;
            }
          } else {
            amountAED = uPrice * q;
          }

          const newSale = {
            id: 's' + Date.now(),
            ts: new Date().toLocaleString(),
            product,
            qty: q,
            unitPrice: uPrice,
            paymentType,
            studentBucks: sb,
            amountAED,
          };

          setSales(prev => [newSale, ...prev]);

          // üîó Send to Google Sheet
          fetch(SHEET_URL, {
            method: "POST",
            body: JSON.stringify(newSale),
            headers: { "Content-Type": "application/json" },
          })
          .then(res => res.text())
          .then(txt => setMessage("‚úÖ Synced to Google Sheet!"))
          .catch(err => {
            console.error("Error sending to sheet:", err);
            setMessage("‚ö†Ô∏è Could not sync ‚Äî check connection");
          });

          setTimeout(() => setMessage(''), 4000);
          setQty(1);
          setStudentBucksReceived('');
        }

        return (
          <div className="space-y-6">
            <header className="flex items-center justify-between">
              <div>
                <h1 className="text-3xl font-extrabold text-yellow-600 flex items-center gap-3">
                  <span>üçü</span> The Fun Crunch
                </h1>
                <p className="text-sm text-gray-600">
                  Sales Tracker ‚Ä¢ Student Souk Edition
                </p>
              </div>
              <div className="text-right text-sm text-gray-600">
                {message && (
                  <div
                    className={`px-3 py-1 rounded-md font-semibold ${
                      message.includes("‚úÖ")
                        ? "bg-green-100 text-green-700"
                        : "bg-yellow-100 text-yellow-700"
                    }`}
                  >
                    {message}
                  </div>
                )}
              </div>
            </header>

            {/* Input Section */}
            <div className="bg-white shadow rounded-lg p-6 grid md:grid-cols-2 gap-4">
              <div className="space-y-3">
                <label className="block text-sm font-medium text-gray-700">Product</label>
                <select
                  className="w-full rounded-md p-2 border"
                  value={product}
                  onChange={e => setProduct(e.target.value)}
                >
                  {PRODUCTS.map(p => (
                    <option key={p.key} value={p.key}>{p.label}</option>
                  ))}
                </select>

                <div>
                  <label className="block text-sm font-medium text-gray-700">Unit Price (AED)</label>
                  <input
                    type="number"
                    className="w-full rounded-md p-2 border"
                    value={unitPrice}
                    onChange={e => setUnitPrice(e.target.value)}
                  />
                </div>

                <div className="flex gap-3">
                  <div className="flex-1">
                    <label className="block text-sm font-medium text-gray-700">Quantity</label>
                    <input
                      type="number"
                      className="w-full rounded-md p-2 border"
                      value={qty}
                      onChange={e => setQty(e.target.value)}
                    />
                  </div>

                  <div className="flex-1">
                    <label className="block text-sm font-medium text-gray-700">Payment Type</label>
                    <select
                      className="w-full rounded-md p-2 border"
                      value={paymentType}
                      onChange={e => setPaymentType(e.target.value)}
                    >
                      <option value="studentbucks">üéüÔ∏è Student Bucks</option>
                      <option value="aed">üí≥ AED</option>
                    </select>
                  </div>
                </div>

                {paymentType === "studentbucks" && (
                  <div>
                    <label className="block text-sm font-medium text-gray-700">Student Bucks Received (optional)</label>
                    <input
                      type="number"
                      className="w-full rounded-md p-2 border"
                      value={studentBucksReceived}
                      onChange={e => setStudentBucksReceived(e.target.value)}
                      placeholder="Auto-calculated if left blank"
                    />
                  </div>
                )}

                <button
                  onClick={handleAddSale}
                  className="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md font-semibold w-full"
                >
                  ‚ûï Add Sale
                </button>
              </div>

              {/* Totals */}
              <div className="p-4 bg-gradient-to-br from-yellow-100 to-red-50 rounded-lg shadow">
                <h3 className="font-bold text-lg text-yellow-700">Live Totals</h3>
                <div className="grid grid-cols-2 gap-3 mt-3">
                  <div className="bg-white p-2 rounded text-center shadow">
                    <div className="text-xs text-gray-500">Total Revenue</div>
                    <div className="font-bold">{formatAED(totals.totalAED)}</div>
                  </div>
                  <div className="bg-white p-2 rounded text-center shadow">
                    <div className="text-xs text-gray-500">Total SB Collected</div>
                    <div className="font-bold">{totals.totalSB.toFixed(2)} SB</div>
                    <div className="text-xs text-gray-400">{formatAED(totals.totalSB * SB_TO_AED)}</div>
                  </div>
                </div>
              </div>
            </div>

            {/* Transactions */}
            <div className="bg-white p-4 rounded shadow">
              <h3 className="font-bold">Recent Sales</h3>
              <div className="mt-2 space-y-2">
                {sales.slice(0, 5).map(s => (
                  <div key={s.id} className="border p-2 rounded flex justify-between">
                    <div>
                      <div className="font-semibold text-sm">
                        {PRODUCTS.find(p => p.key === s.product)?.label} √ó {s.qty}
                      </div>
                      <div className="text-xs text-gray-500">
                        {s.ts} ‚Ä¢ {s.paymentType === 'studentbucks'
                          ? `${s.studentBucks} SB (${formatAED(s.amountAED)})`
                          : formatAED(s.amountAED)}
                      </div>
                    </div>
                    <div className="font-semibold">{formatAED(s.amountAED)}</div>
                  </div>
                ))}
                {!sales.length && <div className="text-sm text-gray-500">No sales yet.</div>}
              </div>
            </div>

            <div className="text-center">
              <button
                onClick={() => downloadCSV(sales)}
                className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md font-semibold"
              >
                üì• Download CSV
              </button>
            </div>

            <footer className="text-center text-xs text-gray-500 mt-4">
              Built for The Fun Crunch ‚Ä¢ Synced with Google Sheets
            </footer>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
