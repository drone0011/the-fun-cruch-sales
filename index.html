<script type="text/babel">
const { useState, useEffect } = React;

const PRODUCTS = [
  { key: 'spinchip', label: 'üçü Spin (Chips)' },
  { key: 'spindrink', label: 'üéØ Spin (Drinks)' },
  { key: 'random', label: 'üïµÔ∏è‚Äç‚ôÇÔ∏è Mystery Item (Spin)' },
  { key: 'random2', label: 'üïµÔ∏è‚Äç‚ôÇÔ∏è Mystery Item (Bag)' },
  { key: 'mysterychip', label: 'üõçÔ∏è Mystery Bag (Chips)' },
  { key: 'mysterydrink', label: 'ü•§ Mystery Bag (Drinks)' },
  { key: 'chip', label: 'üçü Chips' },
  { key: 'drink', label: 'üßÉ Drink' },
  { key: 'combo1', label: 'üßÉ Combo 1 (1 Chip + 1 Drink)'},
  { key: 'combo2', label: 'üßÉ Combo 2 (1 Chip/Drink + Card)'},
  { key: 'card5', label: 'üÉè Refer A Friend Card (AED 5)'},
  { key: 'card10', label: 'üÉè Lucky Draw Card (AED 10)'},
  { key: 'cards', label: 'üÉè Cards'},
  { key: 'packs', label: 'üÉè Packs'},
];

const SB_TO_AED = 5;
const LOCAL_KEY = 'funcrunch_sales_v2';

function formatAED(n){
  const num = Number(n) || 0;
  return 'AED ' + (Math.round(num*100)/100).toFixed(2);
}

// CSV helper: serialize cart as JSON so CSV stays valid
function downloadCSV(rows, filename='funcrunch_sales.csv'){
  if(!rows || rows.length === 0){
    alert('No sales to export.');
    return;
  }
  const sanitized = rows.map(r => ({
    id: r.id,
    ts: r.ts,
    cart: JSON.stringify(r.cart || []),
    qty: r.qty,
    paymentType: r.paymentType,
    studentBucks: r.studentBucks,
    amountAED: r.amountAED
  }));
  const header = Object.keys(sanitized[0]);
  const csv = [
    header.join(','),
    ...sanitized.map(row => header.map(h => {
      const v = row[h] === null || row[h] === undefined ? '' : String(row[h]).replace(/"/g,'""');
      return /,|\n|"/.test(v) ? `"${v}"` : v;
    }).join(','))
  ].join('\n');
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

function App(){
  const [sales, setSales] = useState([]);
  const [product, setProduct] = useState(PRODUCTS[0].key);
  const [unitPrice, setUnitPrice] = useState(5.00);
  const [qty, setQty] = useState(1);
  const [paymentType, setPaymentType] = useState('studentbucks');
  const [studentBucksReceived, setStudentBucksReceived] = useState('');
  const [cart, setCart] = useState([]);
  const [lastSaved, setLastSaved] = useState(null);

  // load
  useEffect(() => {
    try {
      const raw = localStorage.getItem(LOCAL_KEY);
      if(raw){ setSales(JSON.parse(raw)); }
    } catch(e){ console.error(e); }
  }, []);

  // save
  useEffect(() => {
    localStorage.setItem(LOCAL_KEY, JSON.stringify(sales));
    setLastSaved(new Date().toLocaleString());
  }, [sales]);

  // totals: handle both old single-item sales and new cart-style sales
  const totals = sales.reduce((acc, s) => {
    acc.totalAED += Number(s.amountAED || 0);
    acc.totalSB += Number(s.studentBucks || 0);

    // if this sale has a cart (new format), count per item
    if (Array.isArray(s.cart)) {
      s.cart.forEach(item => {
        if(!item || !item.product) return;
        acc.units[item.product] = (acc.units[item.product] || 0) + Number(item.qty || 0);
      });
    } else if (s.product) {
      // fallback to old format single-item sales
      acc.units[s.product] = (acc.units[s.product] || 0) + Number(s.qty || 0);
    }
    return acc;
  }, { totalAED:0, totalSB:0, units:{} });

  function addItemToCart(){
    const q = Math.max(1, Math.floor(Number(qty) || 1));
    const price = Number(unitPrice) || 0;
    setCart(prev => [...prev, { product, qty: q, unitPrice: price }]);
    setQty(1);
  }

  function removeCartItem(index){
    setCart(prev => prev.filter((_, i) => i !== index));
  }

  function handleConfirmSale(){
    if(cart.length === 0){ alert("Add at least one item to the cart first."); return; }

    const totalAEDFromCart = cart.reduce((sum, it) => sum + (Number(it.unitPrice||0) * Number(it.qty||0)), 0);
    let totalAED = totalAEDFromCart;
    let sb = 0;

    if(paymentType === 'studentbucks'){
      if(studentBucksReceived !== ''){
        sb = Number(studentBucksReceived) || 0;
        totalAED = sb * SB_TO_AED;
      } else {
        sb = Math.round((totalAEDFromCart / SB_TO_AED) * 100) / 100;
      }
    }

    // deep copy cart for immutability safety
    const saleCart = cart.map(i => ({ ...i }));

    const newSale = {
      id: 'r' + Date.now(),
      ts: new Date().toLocaleString(),
      cart: saleCart,
      qty: saleCart.reduce((sum,i)=>sum + Number(i.qty||0), 0),
      paymentType,
      studentBucks: sb,
      amountAED: Number(totalAED.toFixed(2))
    };

    setSales(prev => [newSale, ...prev]);
    setCart([]);
    setStudentBucksReceived('');
  }

  function handleResetDay(){
    if(!confirm('Reset day? Download CSV first to keep a backup.')) return;
    if(sales.length) downloadCSV(sales, 'funcrunch_sales_backup_' + new Date().toISOString().slice(0,10) + '.csv');
    setSales([]);
    localStorage.removeItem(LOCAL_KEY);
  }

  return (
    <div className="space-y-6">
      <header className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-extrabold text-yellow-600 flex items-center gap-3">
            <span>üçü</span> <span>The Fun Crunch</span>
          </h1>
          <p className="text-sm text-gray-600">Multi-item Receipt Sales Tracker</p>
        </div>
        <div className="text-right text-sm text-gray-600">
          <div>Last saved:</div>
          <div className="font-medium">{ lastSaved || '‚Äî' }</div>
        </div>
      </header>

      <div className="bg-white shadow rounded-lg p-6 grid md:grid-cols-2 gap-4">
        <div className="space-y-3">
          <label className="block text-sm font-medium text-gray-700">Product</label>
          <select className="w-full rounded-md p-2 border" value={product} onChange={e=>setProduct(e.target.value)}>
            {PRODUCTS.map((p, idx) => <option key={`${p.key}-${idx}`} value={p.key}>{p.label}</option>)}
          </select>

          <div>
            <label className="block text-sm font-medium text-gray-700">Unit Price (AED)</label>
            <input type="number" step="0.01" className="w-full rounded-md p-2 border" value={unitPrice} onChange={e=>setUnitPrice(e.target.value)} />
          </div>

          <div className="flex gap-3">
            <div className="flex-1">
              <label className="block text-sm font-medium text-gray-700">Quantity</label>
              <input type="number" min="1" className="w-full rounded-md p-2 border" value={qty} onChange={e=>setQty(e.target.value)} />
            </div>
          </div>

          <button onClick={addItemToCart} className="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md font-semibold w-full">‚ûï Add to Cart</button>

          {cart.length > 0 && (
            <div className="bg-yellow-50 border p-3 rounded mt-3">
              <h3 className="font-bold mb-2">üßæ Current Cart</h3>
              {cart.map((item,i)=>(
                <div key={i} className="flex justify-between items-center text-sm mb-1">
                  <span>{PRODUCTS.find(p=>p.key===item.product)?.label || item.product} √ó {item.qty}</span>
                  <span>{formatAED(item.unitPrice * item.qty)}</span>
                  <button onClick={()=>removeCartItem(i)} className="text-red-500 text-xs ml-2">‚úñ</button>
                </div>
              ))}
              <div className="text-right font-semibold border-t pt-1">
                {formatAED(cart.reduce((sum,i)=>sum + (i.unitPrice * i.qty), 0))}
              </div>
            </div>
          )}

          <div className="mt-4">
            <label className="block text-sm font-medium text-gray-700">Payment Type</label>
            <select className="w-full rounded-md p-2 border" value={paymentType} onChange={e=>setPaymentType(e.target.value)}>
              <option value="studentbucks">üéüÔ∏è Student Bucks (1 SB = AED 5)</option>
              <option value="aed">üíµ AED (Cash)</option>
            </select>
          </div>

          {paymentType === 'studentbucks' && (
            <div>
              <label className="block text-sm font-medium text-gray-700">Student Bucks Received (optional)</label>
              <input placeholder="Leave blank to auto-calc" type="number" step="0.01" className="w-full rounded-md p-2 border" value={studentBucksReceived} onChange={e=>setStudentBucksReceived(e.target.value)} />
            </div>
          )}

          <button onClick={handleConfirmSale} className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md font-semibold w-full mt-4">‚úÖ Confirm Sale</button>
        </div>

        <div className="space-y-4">
          <div className="p-4 rounded-lg bg-gradient-to-br from-yellow-100 to-red-50 shadow">
            <h3 className="font-bold text-lg text-yellow-700">Live Totals</h3>
            <div className="grid grid-cols-2 gap-2 mt-2">
              <div className="p-2 bg-white rounded text-center shadow">
                <div className="text-xs text-gray-500">Total Revenue</div>
                <div className="font-semibold text-lg">{formatAED(totals.totalAED)}</div>
              </div>
              <div className="p-2 bg-white rounded text-center shadow">
                <div className="text-xs text-gray-500">Total SB</div>
                <div className="font-semibold text-lg">{totals.totalSB || 0} SB</div>
              </div>
            </div>
          </div>

          <div className="p-4 bg-white rounded shadow">
            <h3 className="font-bold mb-2">Units Sold</h3>
            {PRODUCTS.map((p, idx)=>(
              <div key={`${p.key}-unit-${idx}`} className="flex justify-between text-sm">
                <div>{p.label}</div>
                <div className="font-semibold">{totals.units[p.key] || 0}</div>
              </div>
            ))}
          </div>

          <div className="flex gap-2">
            <button onClick={()=>downloadCSV(sales)} className="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded-md">üì• CSV</button>
            <button onClick={handleResetDay} className="flex-1 bg-red-100 hover:bg-red-200 text-red-700 px-3 py-2 rounded-md">Reset</button>
          </div>
        </div>
      </div>

      <div className="bg-white p-4 rounded shadow">
        <h3 className="font-bold mb-2">Recent Receipts</h3>
        {sales.slice(0,5).map(s=>(
          <div key={s.id} className="border rounded p-2 mb-2 text-sm">
            <div className="font-semibold">{s.ts}</div>
            {Array.isArray(s.cart) && s.cart.map((i,idx)=>(
              <div key={idx} className="ml-3 flex justify-between">
                <span>{PRODUCTS.find(p=>p.key===i.product)?.label || i.product} √ó {i.qty}</span>
                <span>{formatAED(i.unitPrice * i.qty)}</span>
              </div>
            ))}
            <div className="text-right font-bold mt-1 border-t pt-1">
              Total: {s.paymentType==='studentbucks'? `${s.studentBucks} SB (${formatAED(s.amountAED)})` : formatAED(s.amountAED)}
            </div>
          </div>
        ))}
        {!sales.length && <div className="text-gray-500 text-sm">No sales yet.</div>}
      </div>

      <footer className="text-center text-xs text-gray-500 mt-6">Built for The Fun Crunch ‚Ä¢ Multi-item receipt edition</footer>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
