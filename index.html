<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Fun Crunch ‚Äî Advanced Sales Tracker</title>

  <!-- React + ReactDOM -->

  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>

  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />

  <style>
    @media print {
      body * { visibility: hidden; }
      .receipt-print-area, .receipt-print-area * { visibility: visible; }
      .receipt-print-area { position: absolute; left:0; top:0; width:100%; }
    }
  </style>

</head>

<body class="bg-gray-50 p-6 font-sans">
  <div id="root"></div>

  <script type="text/babel">
    // ---------- Config ----------
    const LOCAL_KEY = "funcrunch_sales_v5";
    const TIMEZONE = "Asia/Dubai";

    const PRODUCTS = [
      { key: "chip", label: "üçü Chips", price: 5.0, stock: 50, img: "üçü" },
      { key: "drinkcan", label: "ü•§ Drink (Can)", price: 4.0, stock: 40, img: "ü•§" },
      { key: "sweets", label: "üç¨ Sweets", price: 2.0, stock: 100, img: "üç¨" },
      { key: "combo1", label: "üßÉ Combo 1 (1 Chip + 1 Drink)", price: 8.0, stock: 20, img: "üßÉ" },
      { key: "mysterybag", label: "üõçÔ∏è Mystery Bag", price: 6.0, stock: 15, img: "üéÅ" },

      // Games
      { key: "spinwheel", label: "Spin the Wheel / Lucky Draw", price: 8, stock: 1000, img: "üé°" },
      { key: "dicespin", label: "Dice Spin", price: 8, stock: 1000, img: "üé≤" },

      { key: "draw", label: "Luckydraw (Standard)", price: 2, stock: 1000, img: "üé≤" },
      { key: "drawprem", label: "Luckydraw (Premium)", price: 4, stock: 1000, img: "üéØ" },
      { key: "scratchoff", label: "Scratch Card", price: 2, stock: 1000, img: "üé´" }
    ];

    function formatAED(n) {
      return "AED " + (Math.round(n*100)/100).toFixed(2);
    }

    function nowString() {
      try {
        return new Date().toLocaleString("en-GB", {
          timeZone: TIMEZONE,
          year: "numeric",
          month: "short",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
          hour12: false
        }) + ` (${TIMEZONE})`;
      } catch(e) {
        return new Date().toLocaleString() + ` (${TIMEZONE})`;
      }
    }

    function downloadCSV(rows, filename="funcrunch_sales.csv") {
      if (!rows.length) return;
      const header = Object.keys(rows[0]);
      const csv = [header.join(","), ...rows.map(r => header.map(h=>{
        const v = r[h]==null ? "" : String(r[h]).replace(/"/g,'""');
        return /,|\n|"/.test(v) ? `"${v}"` : v;
      }).join(","))].join("\n");
      const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ---------- App ----------
    function App() {
      const [products,setProducts] = React.useState(PRODUCTS);
      const [sales,setSales] = React.useState([]);
      const [cart,setCart] = React.useState([]);
      const [selectedProduct,setSelectedProduct] = React.useState(PRODUCTS[0].key);
      const [qty,setQty] = React.useState(1);
      const [unitPrice,setUnitPrice] = React.useState(PRODUCTS[0].price);
      const [itemDiscount,setItemDiscount] = React.useState(0);
      const [overallDiscount,setOverallDiscount] = React.useState(0);
      const [paymentType,setPaymentType] = React.useState("card");
      const [autoPrint,setAutoPrint] = React.useState(false);
      const [lastSaved,setLastSaved] = React.useState(null);
      const [campaigns,setCampaigns] = React.useState(["Walk-in","Promo A"]);
      const [selectedCampaign,setSelectedCampaign] = React.useState("Walk-in");
      const [lowStockThreshold,setLowStockThreshold] = React.useState(5);

      React.useEffect(()=>{
        try {
          const raw = localStorage.getItem(LOCAL_KEY);
          if(raw){
            const parsed = JSON.parse(raw);
            if(parsed.products) setProducts(parsed.products);
            if(parsed.sales) setSales(parsed.sales);
            if(parsed.campaigns) setCampaigns(parsed.campaigns);
          }
        }catch(e){console.error("Load failed:",e);}
      },[]);

      React.useEffect(()=>{
        const toSave = {products,sales,campaigns};
        localStorage.setItem(LOCAL_KEY,JSON.stringify(toSave));
        setLastSaved(nowString());
      },[products,sales,campaigns]);

      const totals = sales.reduce((acc,s)=>{
        acc.totalAED += Number(s.amountAED||0);
        acc.units[s.productKey] = (acc.units[s.productKey]||0)+Number(s.qty||0);
        return acc;
      },{totalAED:0,units:{}});

      function addItemToCart(){
        if(!selectedProduct) return alert("Select a product.");
        const prod = products.find(p=>p.key===selectedProduct);
        const q = Number(qty)||0;
        if(q<1) return alert("Quantity must be at least 1.");
        if(prod.stock<q) return alert(`Not enough stock for ${prod.label}. Current: ${prod.stock}`);
        const price = Number(unitPrice)||prod.price;
        const discountPct = Math.max(0,Math.min(100,Number(itemDiscount)||0));
        setCart(prev=>[...prev,{productKey:prod.key,label:prod.label,qty:q,unitPrice:price,itemDiscountPct:discountPct}]);
        setQty(1); setItemDiscount(0);
      }

      function removeCartItem(i){ setCart(cart.filter((_,idx)=>idx!==i)); }

      function applyInventoryChange(productKey,delta){
        setProducts(prev=>prev.map(p=>p.key===productKey?{...p,stock:Math.max(0,p.stock+delta)}:p));
      }

      function handleConfirmSale(){
        if(!cart.length) return alert("Add items to cart first.");
        let subtotal=0;
        cart.forEach(it=>{
          const line = it.unitPrice*it.qty;
          const discounted = line*(1-(it.itemDiscountPct||0)/100);
          subtotal+=discounted;
        });
        const overallDisc = Math.max(0,Math.min(100,Number(overallDiscount)||0));
        const totalAfterOverall = subtotal*(1-overallDisc/100);
        const amountAED = Number((Math.round(totalAfterOverall*100)/100).toFixed(2));

        const newProducts = products.map(p=>{
          const inCart = cart.find(c=>c.productKey===p.key);
          if(!inCart) return p;
          return {...p,stock:Math.max(0,p.stock-inCart.qty)};
        });
        setProducts(newProducts);

        const sale = {
          id:"r"+Date.now(),
          ts:nowString(),
          campaign:selectedCampaign,
          paymentType,
          cart,
          qty:cart.reduce((s,i)=>s+i.qty,0),
          overallDiscountPct:overallDisc,
          amountAED,
          cashier:"POS"
        };
        setSales(prev=>[sale,...prev]);
        setCart([]);
        setOverallDiscount(0);
        if(autoPrint) printReceipt(sale);
      }

      function printReceipt(sale){
        const receiptHtml = generateReceiptHtml(sale);
        const w = window.open("","_blank","width=400,height=800");
        if(!w) return alert("Popup blocked");
        w.document.write(receiptHtml);
        w.document.close();
        setTimeout(()=>{w.focus(); w.print();},300);
      }

      function generateReceiptHtml(sale){
        const lines = sale.cart.map(i=>{
          const lineTotal=(i.unitPrice*i.qty)*(1-(i.itemDiscountPct||0)/100);
          const discText = i.itemDiscountPct?` (-${i.itemDiscountPct}%)`:"";
          return `<tr><td style="padding:4px">${i.label} √ó ${i.qty}${discText}</td><td style="padding:4px;text-align:right">${formatAED(lineTotal)}</td></tr>`;
        }).join("");
        return `<html><head><meta charset="utf-8"/><title>Receipt ${sale.id}</title><style>
          body{font-family:Arial,sans-serif;padding:12px;}
          h2{margin-bottom:6px;}
          table{width:100%;border-collapse:collapse;margin-top:8px;}
          td{border-bottom:1px dashed #ddd;}
          .total{font-weight:bold;font-size:1.1em;}
        </style></head><body>

```
    <div class="receipt-print-area">
      <h2>The Fun Crunch</h2>
      <div>Receipt: ${sale.id}</div>
      <div>Time: ${sale.ts}</div>
      <div>Campaign: ${sale.campaign}</div>
      <div>Payment: ${sale.paymentType}</div>
      <table>${lines}</table>
      <div style="margin-top:8px" class="total">TOTAL: ${formatAED(sale.amountAED)}</div>
      <div style="margin-top:10px;font-size:12px;color:#666">Thank you! ‚Äî The Fun Crunch</div>
    </div></body></html>`;
  }

  function addCampaign(name){
    const nm=(name||"").trim();
    if(!nm) return;
    if(campaigns.includes(nm)) return alert("Campaign already exists.");
    setCampaigns(c=>[nm,...c]);
    setSelectedCampaign(nm);
  }

  function resetCampaignTotals(campaignName){
    if(!confirm(`Reset sales for campaign "${campaignName}"? This will remove sales entries for that campaign.`)) return;
    setSales(prev=>prev.filter(s=>s.campaign!==campaignName));
  }

  function exportSalesCSV(){
    if(!sales.length) return alert("No sales to export.");
    const rows = sales.map(s=>({
      id:s.id,
      ts:s.ts,
      campaign:s.campaign,
      paymentType:s.paymentType,
      qty:s.qty,
      amountAED:s.amountAED,
      items:s.cart.map(i=>`${i.label}√ó${i.qty}${i.itemDiscountPct?`(-${i.itemDiscountPct}%)`:""}`).join(" | ")
    }));
    downloadCSV(rows,`funcrunch_sales_${new Date().toISOString().slice(0,10)}.csv`);
  }

  // ---------- UI ----------
  return (
    <div className="max-w-6xl mx-auto space-y-6">
      <h1 className="text-3xl font-extrabold text-yellow-600 flex items-center gap-3">
        üçü The Fun Crunch ‚Äî Advanced POS
      </h1>
      <p className="text-sm text-gray-600">Sales tracker ‚Äî discounts, inventory, campaigns, print receipts</p>
    </div>
  );
}

try {
  ReactDOM.createRoot(document.getElementById("root")).render(<App />);
} catch(err) {
  document.body.innerHTML=`<pre style="color:red">${err}</pre>`;
  console.error(err);
}
```

  </script>
</body>
</html>
